<!DOCTYPE html>
<html lang="en-us" dir="ltr">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.5">
<title>Building a Layer 7 Load Balancer | kbabuji</title>
    <link rel="stylesheet" href="/css/main.css">
      <script src="/js/main.js"></script>
  <meta itemprop="name" content="Building a Layer 7 Load Balancer">
  <meta itemprop="description" content="Behind every high-performing system lies a load balancer making invisible yet critical decisions—discover how these unsung heroes shape the digital world.">
  <meta itemprop="datePublished" content="2024-09-15T15:05:28-06:00">
  <meta itemprop="dateModified" content="2024-09-15T15:05:28-06:00">
  <meta itemprop="wordCount" content="2005">
  <meta itemprop="image" content="http://localhost:1313/articles/building-a-layer7-load-balancer/load_balancer.webp">
  <meta itemprop="keywords" content="golang,layer 7 load balancer"><meta property="og:url" content="http://localhost:1313/articles/building-a-layer7-load-balancer/">
  <meta property="og:site_name" content="kbabuji">
  <meta property="og:title" content="Building a Layer 7 Load Balancer">
  <meta property="og:description" content="Behind every high-performing system lies a load balancer making invisible yet critical decisions—discover how these unsung heroes shape the digital world.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="articles">
    <meta property="article:published_time" content="2024-09-15T15:05:28-06:00">
    <meta property="article:modified_time" content="2024-09-15T15:05:28-06:00">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="Load Balancer">
    <meta property="og:image" content="http://localhost:1313/articles/building-a-layer7-load-balancer/load_balancer.webp">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap');
</style>
</head>

<body>
  <header class="navbar">
    <div class="masthead">
    <h2 ><a class="site-title" href="/">kbabuji</a></h2>
    <nav class="nav-links">
        <a href="/about">About</a>
        <a href="/articles">Archives</a>
        <a href="/categories">Categories</a>
    </nav>
</div>
  </header>
  <main class="wrapper">
    
<article class="article-container">
    
    <header class="article-header">
        <div class="category">System Design &amp; Architecture</div>
        <h1 class="title">Building a Layer 7 Load Balancer</h1>
        <p class="description">Behind every high-performing system lies a load balancer making invisible yet critical decisions—discover how these unsung heroes shape the digital world.</p>
        <div class="meta">
            <time datetime="2024-09-15">
                September 15, 2024
            </time>
        </div>
    </header>
    <div class="minimal-divider"></div>

    
    <div class="content">
        <p>Load balancers are essential for applications or services that handle high volumes of traffic, ensuring that they can scale efficiently to meet demand. Modern load balancers have evolved into comprehensive traffic management solutions, often incorporating rate limiting, caching, DDoS protection, and more, making them indispensable for high-scale systems.</p>
<h2 id="what-is-a-load-balancer">
  What is a load balancer?
  <a class="anchor" href="#what-is-a-load-balancer" aria-label="Link to section - What is a load balancer?">#</a>
</h2>

<p>Imagine you&rsquo;re at an airport, standing in line for the security check. There is a single line of passengers, but there are five booths with agents checking boarding passes and IDs. At the front of the line, there is an agent directing passengers to available booths. This agent acts like a basic load balancer, distributing incoming requests (passengers) to backend servers (TSA agents) for processing.</p>
<p>A load balancer does more than distribute requests. It also monitors the health of backend servers by periodically sending health checks or heartbeats to ensure they&rsquo;re functioning properly. Load balancers periodically run health checks so that requests do not get routed to unhealthy servers.</p>
<p>Types of Load Balancers</p>
<p>There are two common types of load balancers:</p>
<ol>
<li><strong>Layer 4 Load Balancer</strong>: Operates at the transport layer (TCP/UDP), distributing traffic based on IP addresses and ports.</li>
<li><strong>Layer 7 Load Balancer</strong>: Operates at the application layer (HTTP), distributing requests based on more granular details such as URL paths, headers, and even request content.</li>
</ol>
<p>Popular load balancers include AWS <a href="https://aws.amazon.com/elasticloadbalancing/">Elastic Load Balancer</a>, <a href="https://www.f5.com/go/product/welcome-to-nginx">NGINX</a>, and <a href="https://www.haproxy.org/">HAProxy</a>.</p>
<hr>
<h2 id="what-is-a-layer-4-load-balancer">
  What is a layer 4 load balancer?
  <a class="anchor" href="#what-is-a-layer-4-load-balancer" aria-label="Link to section - What is a layer 4 load balancer?">#</a>
</h2>

<p>A Layer 4 load balancer operates at the transport layer (OSI Layer 4), distributing network traffic based on information from the TCP/UDP protocol. It does not inspect the application-level data, meaning it forwards packets to the backend servers without interpreting their content. Layer 4 load balancers make decisions based on the destination IP address and port.</p>
<p>Below is a diagram of a simple load balancer. Requests (R1, R2, R3, R4) are distributed to three backend servers, and the forwarded requests are shown as FR1, FR2, FR3, and FR4.</p>
<figure><img src="/articles/building-a-layer7-load-balancer/load_balancer.webp" loading="lazy"><figcaption>
      <h4>Diagram of a load balancer</h4>
    </figcaption>
</figure>

<p>Below is code for a simple load balancer that supports HTTP routes request in a Round Robin fashion.</p>
<div class="highlight" id="minimal-l4"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 1</span><span><span style="color:#8bd5ca">package</span> main
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 3</span><span><span style="color:#8bd5ca">import</span> (
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 4</span><span>	<span style="color:#a6da95">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 5</span><span>	<span style="color:#a6da95">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 6</span><span>	<span style="color:#a6da95">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 7</span><span>	<span style="color:#a6da95">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 8</span><span>	<span style="color:#a6da95">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 9</span><span>	<span style="color:#a6da95">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">10</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">12</span><span><span style="color:#ed8796">type</span> Backend <span style="color:#ed8796">struct</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">13</span><span>	URL    <span style="color:#ed8796">string</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">14</span><span>	Alive  <span style="color:#ed8796">bool</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">15</span><span>	Health <span style="color:#ed8796">string</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">16</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">17</span><span><span style="color:#ed8796">type</span> LoadBalancer <span style="color:#ed8796">struct</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">18</span><span>	backends []<span style="color:#91d7e3;font-weight:bold">*</span>Backend
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">19</span><span>	current  <span style="color:#ed8796">uint32</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">20</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">22</span><span><span style="color:#ed8796">func</span> (lb <span style="color:#91d7e3;font-weight:bold">*</span>LoadBalancer) <span style="color:#8aadf4">getNextBackend</span>() <span style="color:#91d7e3;font-weight:bold">*</span>Backend {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">23</span><span>	next <span style="color:#91d7e3;font-weight:bold">:=</span> atomic.<span style="color:#8aadf4">AddUint32</span>(<span style="color:#91d7e3;font-weight:bold">&amp;</span>lb.current, <span style="color:#f5a97f">1</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">24</span><span>	<span style="color:#c6a0f6">return</span> lb.backends[next<span style="color:#91d7e3;font-weight:bold">%</span><span style="color:#91d7e3">uint32</span>(<span style="color:#91d7e3">len</span>(lb.backends))]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">25</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">26</span><span><span style="color:#6e738d;font-style:italic">// Periodically check all backends for health</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">27</span><span><span style="color:#ed8796">func</span> (lb <span style="color:#91d7e3;font-weight:bold">*</span>LoadBalancer) <span style="color:#8aadf4">healthCheck</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">28</span><span>	<span style="color:#c6a0f6">for</span> _, backend <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#c6a0f6">range</span> lb.backends {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">29</span><span>		<span style="color:#c6a0f6">go</span> <span style="color:#ed8796">func</span>(b <span style="color:#91d7e3;font-weight:bold">*</span>Backend) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">30</span><span>			<span style="color:#c6a0f6">for</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">31</span><span>				resp, err <span style="color:#91d7e3;font-weight:bold">:=</span> http.<span style="color:#8aadf4">Get</span>(b.URL <span style="color:#91d7e3;font-weight:bold">+</span> b.Health)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">32</span><span>				<span style="color:#c6a0f6">if</span> err <span style="color:#91d7e3;font-weight:bold">!=</span> <span style="color:#f5a97f">nil</span> <span style="color:#91d7e3;font-weight:bold">||</span> resp.StatusCode <span style="color:#91d7e3;font-weight:bold">!=</span> http.StatusOK {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">33</span><span>					b.Alive = <span style="color:#f5a97f">false</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">34</span><span>					log.<span style="color:#8aadf4">Printf</span>(<span style="color:#a6da95">&#34;Backend %s is down\n&#34;</span>, b.URL)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">35</span><span>				} <span style="color:#c6a0f6">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">36</span><span>					b.Alive = <span style="color:#f5a97f">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">37</span><span>					log.<span style="color:#8aadf4">Printf</span>(<span style="color:#a6da95">&#34;Backend %s is up\n&#34;</span>, b.URL)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">38</span><span>				}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">39</span><span>				time.<span style="color:#8aadf4">Sleep</span>(<span style="color:#f5a97f">10</span> <span style="color:#91d7e3;font-weight:bold">*</span> time.Second)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">40</span><span>			}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">41</span><span>		}(backend)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">42</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">43</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">44</span><span><span style="color:#6e738d;font-style:italic">// Proxy forwards the request r to a backend and returns response w</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">45</span><span><span style="color:#ed8796">func</span> (lb <span style="color:#91d7e3;font-weight:bold">*</span>LoadBalancer) <span style="color:#8aadf4">proxy</span>(w http.ResponseWriter, r <span style="color:#91d7e3;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">46</span><span>	backend <span style="color:#91d7e3;font-weight:bold">:=</span> lb.<span style="color:#8aadf4">getNextBackend</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">47</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">48</span><span>    <span style="color:#6e738d;font-style:italic">// Forward request to backend</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">49</span><span>	resp, err <span style="color:#91d7e3;font-weight:bold">:=</span> http.<span style="color:#8aadf4">Get</span>(backend.URL <span style="color:#91d7e3;font-weight:bold">+</span> r.URL.Path)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">50</span><span>	<span style="color:#c6a0f6">if</span> err <span style="color:#91d7e3;font-weight:bold">!=</span> <span style="color:#f5a97f">nil</span> <span style="color:#91d7e3;font-weight:bold">||</span> !backend.Alive {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">51</span><span>		http.<span style="color:#8aadf4">Error</span>(w, <span style="color:#a6da95">&#34;Backend unavailable&#34;</span>, http.StatusServiceUnavailable)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">52</span><span>		<span style="color:#c6a0f6">return</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">53</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">54</span><span>	<span style="color:#c6a0f6">defer</span> resp.Body.<span style="color:#8aadf4">Close</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">55</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">56</span><span>    <span style="color:#6e738d;font-style:italic">// Copies the response back to client</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">57</span><span>	<span style="color:#c6a0f6">for</span> k, v <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#c6a0f6">range</span> resp.Header {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">58</span><span>		w.<span style="color:#8aadf4">Header</span>()[k] = v
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">59</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">60</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">61</span><span>	_, err = io.<span style="color:#8aadf4">Copy</span>(w, resp.Body)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">62</span><span>	<span style="color:#c6a0f6">if</span> err <span style="color:#91d7e3;font-weight:bold">!=</span> <span style="color:#f5a97f">nil</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">63</span><span>		log.<span style="color:#8aadf4">Printf</span>(<span style="color:#a6da95">&#34;Error copying response from backend: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">64</span><span>		http.<span style="color:#8aadf4">Error</span>(w, <span style="color:#a6da95">&#34;Error forwarding response&#34;</span>, http.StatusInternalServerError)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">65</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">66</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">67</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">68</span><span><span style="color:#ed8796">func</span> <span style="color:#8aadf4">main</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">69</span><span>    <span style="color:#6e738d;font-style:italic">// This can be any list of backends that you have</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">70</span><span>	backends <span style="color:#91d7e3;font-weight:bold">:=</span> []<span style="color:#91d7e3;font-weight:bold">*</span>Backend{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">71</span><span>		{URL: <span style="color:#a6da95">&#34;http://localhost:8081&#34;</span>, Alive: <span style="color:#f5a97f">true</span>, Health: <span style="color:#a6da95">&#34;/health&#34;</span>},
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">72</span><span>		{URL: <span style="color:#a6da95">&#34;http://localhost:8082&#34;</span>, Alive: <span style="color:#f5a97f">true</span>, Health: <span style="color:#a6da95">&#34;/health&#34;</span>},
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">73</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">74</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">75</span><span>	lb <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#91d7e3;font-weight:bold">&amp;</span>LoadBalancer{backends: backends}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">76</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">77</span><span>	<span style="color:#c6a0f6">go</span> lb.<span style="color:#8aadf4">healthCheck</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">78</span><span>	http.<span style="color:#8aadf4">HandleFunc</span>(<span style="color:#a6da95">&#34;/&#34;</span>, lb.proxy)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">79</span><span>	fmt.<span style="color:#8aadf4">Println</span>(<span style="color:#a6da95">&#34;Load Balancer started at :8080&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">80</span><span>	log.<span style="color:#8aadf4">Fatal</span>(http.<span style="color:#8aadf4">ListenAndServe</span>(<span style="color:#a6da95">&#34;:8080&#34;</span>, <span style="color:#f5a97f">nil</span>))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">81</span><span>}
</span></span></code></pre></div><p>You can refer to this <a href="https://kasvith.me/posts/lets-create-a-simple-lb-go/">article</a> which I referred for inspiration when building a simple load balancer.</p>
<hr>
<h2 id="what-is-a-layer-7-load-balancer">
  What is a layer 7 load balancer?
  <a class="anchor" href="#what-is-a-layer-7-load-balancer" aria-label="Link to section - What is a layer 7 load balancer?">#</a>
</h2>

<p>Layer 7 load balancers operate at the application layer (OSI Layer 7) and are more &ldquo;intelligent&rdquo; compared to Layer 4 load balancers. They can inspect request URLs, headers, and even body content, allowing them to make more sophisticated routing decisions based on application-level data.</p>
<h3 id="key-features-of-layer-7-load-balancers">
  Key Features of Layer 7 Load Balancers:
  <a class="anchor" href="#key-features-of-layer-7-load-balancers" aria-label="Link to section - Key Features of Layer 7 Load Balancers:">#</a>
</h3>

<ul>
<li><strong>Routing based on URLs and parameters</strong>: They can route requests to specific backend servers based on the request path, query parameters, or headers.</li>
<li><strong>Sticky sessions</strong>: They can ensure that requests from the same user are consistently routed to the same server, which is useful for session persistence.</li>
<li><strong>Caching</strong>: They can cache responses, reducing the need to forward identical requests to the backend servers, which helps improve performance and reduce server load.</li>
</ul>
<p>While these features provide greater flexibility, they also come at the cost of increased complexity, maintenance, and performance overhead. However, for applications with sophisticated routing requirements, Layer 7 load balancers are often worth the trade-offs.</p>
<h2 id="ssl-termination">
  SSL Termination
  <a class="anchor" href="#ssl-termination" aria-label="Link to section - SSL Termination">#</a>
</h2>

<p>Layer 7 load balancers can perform SSL termination, where encrypted SSL/TLS traffic is decrypted at the load balancer, and plain HTTP requests are forwarded to the backend servers. This offloads the computational burden of encryption from the backend servers and centralizes SSL certificate management.</p>
<p>Here’s how you can add SSL termination to your load balancer using Go:</p>
<div class="highlight" id="minimal-SSL-termination"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 1</span><span><span style="color:#8bd5ca">package</span> main
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 3</span><span><span style="color:#8bd5ca">import</span> (
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 4</span><span>	<span style="color:#a6da95">&#34;crypto/tls&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 5</span><span>	<span style="color:#a6da95">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 6</span><span>	<span style="color:#a6da95">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 7</span><span>	<span style="color:#a6da95">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 8</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">10</span><span><span style="color:#ed8796">func</span> <span style="color:#8aadf4">main</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">11</span><span>	<span style="color:#6e738d;font-style:italic">// Load the SSL certificate and key (You need to generate SSL certificates)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">12</span><span>	certFile <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#a6da95">&#34;cert.pem&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">13</span><span>	keyFile <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#a6da95">&#34;key.pem&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">14</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">15</span><span>	<span style="color:#6e738d;font-style:italic">// Define your LoadBalancer handler</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">16</span><span>	lb <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#91d7e3;font-weight:bold">&amp;</span>LoadBalancer{}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">17</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">18</span><span>	<span style="color:#6e738d;font-style:italic">// Create an HTTPS server with SSL termination</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">19</span><span>	server <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#91d7e3;font-weight:bold">&amp;</span>http.Server{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">20</span><span>		Addr:    <span style="color:#a6da95">&#34;:8443&#34;</span>, <span style="color:#6e738d;font-style:italic">// or any other port</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">21</span><span>		Handler: http.<span style="color:#8aadf4">HandlerFunc</span>(lb.proxy),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">22</span><span>		TLSConfig: <span style="color:#91d7e3;font-weight:bold">&amp;</span>tls.Config{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">23</span><span>			MinVersion: tls.VersionTLS13, <span style="color:#6e738d;font-style:italic">// or TLS12 if compatibility is needed</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">24</span><span>		},
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">25</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">26</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">27</span><span>	fmt.<span style="color:#8aadf4">Println</span>(<span style="color:#a6da95">&#34;Load Balancer with SSL started at :8443&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">28</span><span>	<span style="color:#6e738d;font-style:italic">// Start the HTTPS server with SSL</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">29</span><span>	log.<span style="color:#8aadf4">Fatal</span>(server.<span style="color:#8aadf4">ListenAndServeTLS</span>(certFile, keyFile))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">30</span><span>}
</span></span></code></pre></div><p>Key Steps for SSL Termination:</p>
<ul>
<li><strong>SSL Certificate</strong>: You’ll need to generate or obtain SSL certificates (cert.pem and key.pem). For development purposes, you can use self-signed certificates, but in production, you would obtain certificates from a trusted Certificate Authority (CA).</li>
<li><strong>TLS Configuration</strong>: The TLSConfig allows you to specify the minimum TLS version for security. TLS 1.3 is preferred for modern security standards.</li>
<li><strong>HTTPS Server</strong>: The ListenAndServeTLS method starts the HTTPS server, handling SSL/TLS connections.</li>
</ul>
<h2 id="routing-requests">
  Routing requests
  <a class="anchor" href="#routing-requests" aria-label="Link to section - Routing requests">#</a>
</h2>

<p>A Layer 7 load balancer can inspect request URLs and headers, allowing it to route traffic to specific backend services based on the request&rsquo;s path or parameters. This enables the load balancer to route traffic more intelligently. For example, API requests can be routed to different services (e.g., /apiA or /apiB) based on the URL path.</p>
<p>Each backend service typically registers its routes with the load balancer, specifying the paths or criteria that it can handle. The load balancer then forwards the appropriate requests to the right service.</p>
<p><strong>Example: Minimal Request Router in Go</strong></p>
<p>A Layer 7 load balancer can inspect request URLs and headers, allowing it to route traffic to specific backend services based on the request&rsquo;s path or parameters. This enables the load balancer to route traffic more intelligently. For example, API requests can be routed to different services (e.g., /apiA or /apiB) based on the URL path.</p>
<p>Each backend service typically registers its routes with the load balancer, specifying the paths or criteria that it can handle. The load balancer then forwards the appropriate requests to the right service.
Example: Minimal Request Router in Go</p>
<p>Here&rsquo;s a minimal Go code example that demonstrates routing requests to different backend services using a simple path-based routing mechanism.</p>
<div class="highlight" id="minimal-l7"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 1</span><span><span style="color:#8bd5ca">package</span> main
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 3</span><span><span style="color:#8bd5ca">import</span> (
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 4</span><span>	<span style="color:#a6da95">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 5</span><span>	<span style="color:#a6da95">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 6</span><span>	<span style="color:#a6da95">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 7</span><span>	<span style="color:#a6da95">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 8</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">10</span><span><span style="color:#ed8796">type</span> Backend <span style="color:#ed8796">struct</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">11</span><span>	URL <span style="color:#ed8796">string</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">12</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">14</span><span><span style="color:#6e738d;font-style:italic">// RouteTable maps paths to specific backends</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">15</span><span><span style="color:#ed8796">type</span> RouteTable <span style="color:#ed8796">map</span>[<span style="color:#ed8796">string</span>]<span style="color:#91d7e3;font-weight:bold">*</span>Backend
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">16</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">17</span><span><span style="color:#ed8796">type</span> SimpleRouter <span style="color:#ed8796">struct</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">18</span><span>	routes RouteTable
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">19</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">20</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">21</span><span><span style="color:#6e738d;font-style:italic">// NewSimpleRouter initializes a router with predefined routes</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">22</span><span><span style="color:#ed8796">func</span> <span style="color:#8aadf4">NewSimpleRouter</span>(routes RouteTable) <span style="color:#91d7e3;font-weight:bold">*</span>SimpleRouter {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">23</span><span>	<span style="color:#c6a0f6">return</span> <span style="color:#91d7e3;font-weight:bold">&amp;</span>SimpleRouter{routes: routes}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">24</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">25</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">26</span><span><span style="color:#6e738d;font-style:italic">// ServeHTTP implements http.Handler and performs routing</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">27</span><span><span style="color:#ed8796">func</span> (sr <span style="color:#91d7e3;font-weight:bold">*</span>SimpleRouter) <span style="color:#8aadf4">ServeHTTP</span>(w http.ResponseWriter, r <span style="color:#91d7e3;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">28</span><span>	<span style="color:#6e738d;font-style:italic">// Extract the base path (e.g., /apiA, /apiB)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">29</span><span>	basePath <span style="color:#91d7e3;font-weight:bold">:=</span> strings.<span style="color:#8aadf4">Split</span>(r.URL.Path, <span style="color:#a6da95">&#34;/&#34;</span>)[<span style="color:#f5a97f">1</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">30</span><span>	backend, exists <span style="color:#91d7e3;font-weight:bold">:=</span> sr.routes[<span style="color:#a6da95">&#34;/&#34;</span><span style="color:#91d7e3;font-weight:bold">+</span>basePath]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">31</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">32</span><span>	<span style="color:#c6a0f6">if</span> !exists {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">33</span><span>		http.<span style="color:#8aadf4">Error</span>(w, <span style="color:#a6da95">&#34;Service not found&#34;</span>, http.StatusNotFound)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">34</span><span>		<span style="color:#c6a0f6">return</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">35</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">36</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">37</span><span>	<span style="color:#6e738d;font-style:italic">// Forward the request to the appropriate backend</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">38</span><span>	resp, err <span style="color:#91d7e3;font-weight:bold">:=</span> http.<span style="color:#8aadf4">Get</span>(backend.URL <span style="color:#91d7e3;font-weight:bold">+</span> r.URL.Path)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">39</span><span>	<span style="color:#c6a0f6">if</span> err <span style="color:#91d7e3;font-weight:bold">!=</span> <span style="color:#f5a97f">nil</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">40</span><span>		http.<span style="color:#8aadf4">Error</span>(w, <span style="color:#a6da95">&#34;Backend unavailable&#34;</span>, http.StatusServiceUnavailable)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">41</span><span>		<span style="color:#c6a0f6">return</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">42</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">43</span><span>	<span style="color:#c6a0f6">defer</span> resp.Body.<span style="color:#8aadf4">Close</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">44</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">45</span><span>	<span style="color:#6e738d;font-style:italic">// Copy backend response back to client</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">46</span><span>	<span style="color:#c6a0f6">for</span> k, v <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#c6a0f6">range</span> resp.Header {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">47</span><span>		w.<span style="color:#8aadf4">Header</span>()[k] = v
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">48</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">49</span><span>	_, err = http.<span style="color:#8aadf4">Copy</span>(w, resp.Body)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">50</span><span>	<span style="color:#c6a0f6">if</span> err <span style="color:#91d7e3;font-weight:bold">!=</span> <span style="color:#f5a97f">nil</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">51</span><span>		http.<span style="color:#8aadf4">Error</span>(w, <span style="color:#a6da95">&#34;Error forwarding response&#34;</span>, http.StatusInternalServerError)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">52</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">53</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">54</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">55</span><span><span style="color:#ed8796">func</span> <span style="color:#8aadf4">main</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">56</span><span>	<span style="color:#6e738d;font-style:italic">// Register routes to backend services</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">57</span><span>	routes <span style="color:#91d7e3;font-weight:bold">:=</span> RouteTable{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">58</span><span>		<span style="color:#a6da95">&#34;/apiA&#34;</span>: {URL: <span style="color:#a6da95">&#34;http://localhost:8081&#34;</span>},
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">59</span><span>		<span style="color:#a6da95">&#34;/apiB&#34;</span>: {URL: <span style="color:#a6da95">&#34;http://localhost:8082&#34;</span>},
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">60</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">61</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">62</span><span>	router <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#8aadf4">NewSimpleRouter</span>(routes)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">63</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">64</span><span>	<span style="color:#6e738d;font-style:italic">// Start the HTTP server with the router</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">65</span><span>	fmt.<span style="color:#8aadf4">Println</span>(<span style="color:#a6da95">&#34;Load Balancer started at :8080&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">66</span><span>	log.<span style="color:#8aadf4">Fatal</span>(http.<span style="color:#8aadf4">ListenAndServe</span>(<span style="color:#a6da95">&#34;:8080&#34;</span>, router))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">67</span><span>}
</span></span></code></pre></div><hr>
<h2 id="rate-limiting">
  Rate limiting
  <a class="anchor" href="#rate-limiting" aria-label="Link to section - Rate limiting">#</a>
</h2>

<p>Rate limiting is an important feature that prevents backend servers from being overwhelmed by excessive requests during high traffic periods. Without rate limiting or similar protection, servers—or the entire service—could experience downtime or degraded performance.</p>
<p>There are various algorithms used to implement rate limiting, each designed to control the flow of traffic in a different way. One common algorithm is the token bucket rate limiter, which allows a limited number of requests per time window. If the number of requests exceeds this limit, excess requests are denied. There are a couple of algorithms in performing rate limiting, you can refer this <a href="https://blog.logrocket.com/advanced-guide-rate-limiting-api-traffic-management/">link</a> to check it out.</p>
<h3 id="example-token-bucket-rate-limiter-in-go">
  Example: Token Bucket Rate Limiter in Go
  <a class="anchor" href="#example-token-bucket-rate-limiter-in-go" aria-label="Link to section - Example: Token Bucket Rate Limiter in Go">#</a>
</h3>

<p>Below is a minimal implementation of a token bucket rate limiter. The limiter controls the number of requests allowed in a given time window.</p>
<div class="highlight" id="token-bucket"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 1</span><span><span style="color:#8bd5ca">package</span> main
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 3</span><span><span style="color:#8bd5ca">import</span> (
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 4</span><span>	<span style="color:#a6da95">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 5</span><span>	<span style="color:#a6da95">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 6</span><span>	<span style="color:#a6da95">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 7</span><span>	<span style="color:#a6da95">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 8</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">10</span><span><span style="color:#ed8796">type</span> RateLimiter <span style="color:#ed8796">struct</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">11</span><span>	requests   <span style="color:#ed8796">int</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">12</span><span>	limit      <span style="color:#ed8796">int</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">13</span><span>	window     time.Duration
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">14</span><span>	mu         sync.Mutex
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">15</span><span>	resetTimer <span style="color:#91d7e3;font-weight:bold">*</span>time.Ticker
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">16</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">17</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">18</span><span><span style="color:#ed8796">func</span> <span style="color:#8aadf4">NewRateLimiter</span>(limit <span style="color:#ed8796">int</span>, window time.Duration) <span style="color:#91d7e3;font-weight:bold">*</span>RateLimiter {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">19</span><span>	rl <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#91d7e3;font-weight:bold">&amp;</span>RateLimiter{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">20</span><span>		requests:   <span style="color:#f5a97f">0</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">21</span><span>		limit:      limit,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">22</span><span>		window:     window,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">23</span><span>		resetTimer: time.<span style="color:#8aadf4">NewTicker</span>(window),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">24</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">25</span><span>	<span style="color:#c6a0f6">go</span> rl.<span style="color:#8aadf4">reset</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">26</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">27</span><span>	<span style="color:#c6a0f6">return</span> rl
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">28</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">29</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">30</span><span><span style="color:#ed8796">func</span> (rl <span style="color:#91d7e3;font-weight:bold">*</span>RateLimiter) <span style="color:#8aadf4">Allow</span>() <span style="color:#ed8796">bool</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">31</span><span>	rl.mu.<span style="color:#8aadf4">Lock</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">32</span><span>	<span style="color:#c6a0f6">defer</span> rl.mu.<span style="color:#8aadf4">Unlock</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">33</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">34</span><span>	<span style="color:#c6a0f6">if</span> rl.requests <span style="color:#91d7e3;font-weight:bold">&gt;=</span> rl.limit {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">35</span><span>		<span style="color:#c6a0f6">return</span> <span style="color:#f5a97f">false</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">36</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">37</span><span>	rl.requests<span style="color:#91d7e3;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">38</span><span>	<span style="color:#c6a0f6">return</span> <span style="color:#f5a97f">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">39</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">40</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">41</span><span><span style="color:#ed8796">func</span> (rl <span style="color:#91d7e3;font-weight:bold">*</span>RateLimiter) <span style="color:#8aadf4">reset</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">42</span><span>	<span style="color:#c6a0f6">for</span> <span style="color:#c6a0f6">range</span> rl.resetTimer.C {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">43</span><span>		rl.mu.<span style="color:#8aadf4">Lock</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">44</span><span>		rl.requests = <span style="color:#f5a97f">0</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">45</span><span>		rl.mu.<span style="color:#8aadf4">Unlock</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">46</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">47</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">48</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">49</span><span><span style="color:#ed8796">func</span> (rl <span style="color:#91d7e3;font-weight:bold">*</span>RateLimiter) <span style="color:#8aadf4">Middleware</span>(next http.Handler) http.Handler {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">50</span><span>	<span style="color:#c6a0f6">return</span> http.<span style="color:#8aadf4">HandlerFunc</span>(<span style="color:#ed8796">func</span>(w http.ResponseWriter, r <span style="color:#91d7e3;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">51</span><span>		<span style="color:#c6a0f6">if</span> !rl.<span style="color:#8aadf4">Allow</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">52</span><span>			log.<span style="color:#8aadf4">Printf</span>(<span style="color:#a6da95">&#34;Rate limit exceeded for %s&#34;</span>, r.URL.Path)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">53</span><span>			http.<span style="color:#8aadf4">Error</span>(w, <span style="color:#a6da95">&#34;Rate limit exceeded&#34;</span>, http.StatusTooManyRequests)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">54</span><span>			<span style="color:#c6a0f6">return</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">55</span><span>		}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">56</span><span>		next.<span style="color:#8aadf4">ServeHTTP</span>(w, r)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">57</span><span>	})
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">58</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">59</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">60</span><span><span style="color:#ed8796">func</span> <span style="color:#8aadf4">main</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">61</span><span>	limiter <span style="color:#91d7e3;font-weight:bold">:=</span> <span style="color:#8aadf4">NewRateLimiter</span>(<span style="color:#f5a97f">10</span>, time.Minute)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">62</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">63</span><span>	http.<span style="color:#8aadf4">Handle</span>(<span style="color:#a6da95">&#34;/&#34;</span>, limiter.<span style="color:#8aadf4">Middleware</span>(http.<span style="color:#8aadf4">HandlerFunc</span>(<span style="color:#ed8796">func</span>(w http.ResponseWriter, r <span style="color:#91d7e3;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">64</span><span>		w.<span style="color:#8aadf4">Write</span>([]<span style="color:#91d7e3">byte</span>(<span style="color:#a6da95">&#34;Request successful!&#34;</span>))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">65</span><span>	})))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">66</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">67</span><span>	log.<span style="color:#8aadf4">Println</span>(<span style="color:#a6da95">&#34;Server started on :8080&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">68</span><span>	log.<span style="color:#8aadf4">Fatal</span>(http.<span style="color:#8aadf4">ListenAndServe</span>(<span style="color:#a6da95">&#34;:8080&#34;</span>, <span style="color:#f5a97f">nil</span>))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#8087a2">69</span><span>}
</span></span></code></pre></div><p>The above rate limiter is now based on a global request counter rather than IP-based tracking, making it simpler for demonstration purposes.</p>
<hr>
<h2 id="future-improvements">
  Future improvements
  <a class="anchor" href="#future-improvements" aria-label="Link to section - Future improvements">#</a>
</h2>

<p>For future improvements, I plan to:</p>
<ul>
<li>Set up a circuit breaker – To prevent overwhelming backends that are failing or underperforming by temporarily stopping requests to them.</li>
<li>Explore different routing strategies, like weighted round robin or least connections, to optimize request distribution based on backend capacity.</li>
<li>Dynamically update the backend servers list – Automatically remove any failing servers from the list and add new ones without downtime.</li>
<li>Implement session persistence, ensuring that users consistently connect to the same backend during their session.</li>
<li>Cache requests to reduce load on backends and improve response times for repeated requests.</li>
</ul>
<p>See the <a href="https://github.com/krispingal/l7lb">github repository</a>.</p>
    </div>

    
    <footer class="article-footer">
        <nav class="article-tags">
  <ul class="tags" style="padding-left: 0px;padding-top:10px">
      <li><a href="/tags/golang/">Golang</a></li>
      <li><a href="/tags/load-balancer/">Load Balancer</a></li>
  </ul>

        </nav>
    </footer>
</article>
<aside class="related-posts">
<hr class="divider">
<h3 class="further-reading-heading">Continue Reading</h3>
<aside>
  <div class="related-cards">
    
    <a href="/articles/refining-load-balancer/" aria-label="Read more about Refining Load Balancer">
      <div class="related-card">
        <div class="card-category">System Design &amp; Architecture</div>
        <h3>Refining Load Balancer</h3>
        <p class="card-description">What lies beneath a scalable and efficient load balancer? Explore the transformative techniques that turn a basic implementation into a powerhouse of modularity and speed.</p>
      </div>
    </a>
    <a href="/articles/from-jekyll-to-hugo/" aria-label="Read more about From Jekyll to Hugo">
      <div class="related-card">
        <div class="card-category">Programming Patterns &amp; Languages</div>
        <h3>From Jekyll to Hugo</h3>
        <p class="card-description">What makes a developer leave behind a well-loved tool for something new? Dive into the motivations, discoveries, and lessons learned in the shift from Jekyll to Hugo — and uncover the secrets to crafting a custom theme.</p>
      </div>
    </a>
  </div>
</aside>
</aside>
  </main>
  <footer class="footer-nav">
<div class="footer-icons">
    <a href="/" aria-label="Home"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M575.8 255.5c0 18-15 32.1-32 32.1l-32 0 .7 160.2c0 2.7-.2 5.4-.5 8.1l0 16.2c0 22.1-17.9 40-40 40l-16 0c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1L416 512l-24 0c-22.1 0-40-17.9-40-40l0-24 0-64c0-17.7-14.3-32-32-32l-64 0c-17.7 0-32 14.3-32 32l0 64 0 24c0 22.1-17.9 40-40 40l-24 0-31.9 0c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2l-16 0c-22.1 0-40-17.9-40-40l0-112c0-.9 0-1.9 .1-2.8l0-69.7-32 0c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z"/></svg></a>
    <a href="https://github.com/krispingal" target="_blank" aria-label="GitHub"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3 .3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5 .3-6.2 2.3zm44.2-1.7c-2.9 .7-4.9 2.6-4.6 4.9 .3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3 .7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3 .3 2.9 2.3 3.9 1.6 1 3.6 .7 4.3-.7 .7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3 .7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3 .7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></a>
    <a href="https://linkedin.com/in/krishna-babuji" target="_blank" aria-label="LinkedIn"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
    <a href="mailto:krishna.pingal@gmail.com" aria-label="Email"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48L48 64zM0 176L0 384c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-208L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"/></svg></a>
</div>
<p class="footer-copyright">© 2016 &ndash; 2025 kbabuji. All rights reserved.</p>

  </footer>
</body>

</html>